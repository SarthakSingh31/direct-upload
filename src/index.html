<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Direct Upload</title>
    </head>
    <body>
        <form id="upload">
            <input type="file" id="file-upload" name="file">
            <input type="submit" value="Upload">
            <span id="uploaded-percent"></span>
        </form>

        <script>
            document.getElementById("upload").onsubmit = (evt) => {
                evt.preventDefault();

                const file = document.getElementById("file-upload").files[0];
                const up_precent = document.getElementById('uploaded-percent');

                fetch(`get_session_url?name=${encodeURIComponent(file.name)}&content_type=${encodeURIComponent(file.type)}&content_length=${file.size}`)
                    .then((resp) => {
                        resp.text().then((session_url) => {
                            let uploaded = false;
                            
                            // Upload for the first time
                            // This will raise a cors error but the file is actaully uploaded and there is nothing
                            // to worry about
                            const req = new XMLHttpRequest();
                            req.upload.onprogress = (evt) => {
                                up_precent.innerText = ((evt.loaded / evt.total) * 100).toFixed(2) + " %";
                            };
                            req.onerror = (evt) => {
                                console.log(evt);
                            };
                            req.onloadend = async (evt) => {
                                console.log(evt);

                                let requested_succesfully = false;
                                // while (!requested_succesfully) {
                                    fetch(session_url, {
                                        method: "PUT",
                                        headers: { "Content-Length": 0, "Content-Range": `bytes */${file.size}` },
                                    }).then((resp) => {
                                        if (resp.status < 500) {
                                            requested_succesfully = true;
                                        }
                                        if (resp.status < 300) {
                                            uploaded = true;
                                        }
                                    }).await;
                                // }
                            };
                            req.open("PUT", session_url, true);
                            req.send(file);
                        });
                    })
                    .catch(console.log);
            }
        </script>
    </body>
</html>